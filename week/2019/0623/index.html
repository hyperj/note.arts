



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="ARTS 打卡记录">
      
      
        <link rel="canonical" href="https://hyperj.net/note.arts/week/2019/0623/">
      
      
        <meta name="author" content="HyperJ">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="/assets/images/hyperj.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>ARTS - 2019 Week 6-4 - ARTS 打卡记录</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.0284f74d.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.01803549.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="/assets/css/mkdocs/material.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="amber">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#arts-2019-week-6-4" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://hyperj.net/note.arts" title="ARTS 打卡记录" class="md-header-nav__button md-logo">
          
            <img src="/assets/images/hyperj.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              ARTS 打卡记录
            </span>
            <span class="md-header-nav__topic">
              
                ARTS - 2019 Week 6-4
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/hyperj/note.arts/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    hyperj/note.arts
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../.." title="首页" class="md-tabs__link md-tabs__link--active">
        首页
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../share/2019/" title="Share" class="md-tabs__link">
          Share
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../" title="Week" class="md-tabs__link">
          Week
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://hyperj.net/note.arts" title="ARTS 打卡记录" class="md-nav__button md-logo">
      
        <img src="/assets/images/hyperj.png" width="48" height="48">
      
    </a>
    ARTS 打卡记录
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/hyperj/note.arts/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    hyperj/note.arts
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="首页" class="md-nav__link">
      首页
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Share
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Share
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../share/2019/" title="2019" class="md-nav__link">
      2019
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Week
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Week
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="2019" class="md-nav__link">
      2019
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#algorithm" title="Algorithm" class="md-nav__link">
    Algorithm
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#review" title="Review" class="md-nav__link">
    Review
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cosco-an-efficient-facebook-scale-shuffle-service" title="Cosco: An Efficient Facebook-Scale Shuffle Service" class="md-nav__link">
    Cosco: An Efficient Facebook-Scale Shuffle Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#review_1" title="Review" class="md-nav__link">
    Review
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tip" title="Tip" class="md-nav__link">
    Tip
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spark" title="Spark 常用参数" class="md-nav__link">
    Spark 常用参数
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#share" title="Share" class="md-nav__link">
    Share
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spark-shuffle-service" title="Spark Shuffle Service" class="md-nav__link">
    Spark Shuffle Service
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reference" title="Reference" class="md-nav__link">
    Reference
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/hyperj/note.arts/blob/master/docs/week/2019/0623.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="arts-2019-week-6-4">ARTS - 2019 Week 6-4<a class="headerlink" href="#arts-2019-week-6-4" title="Permanent link">&para;</a></h1>
<p>20190623~20190629</p>
<h2 id="algorithm">Algorithm<a class="headerlink" href="#algorithm" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://leetcode.com/problems/valid-parentheses/">20. Valid Parentheses</a></li>
<li><a href="https://leetcode.com/problems/merge-two-sorted-lists/">21. Merge Two Sorted Lists</a></li>
</ul>
<h2 id="review">Review<a class="headerlink" href="#review" title="Permanent link">&para;</a></h2>
<h3 id="cosco-an-efficient-facebook-scale-shuffle-service"><a href="https://databricks.com/session/cosco-an-efficient-facebook-scale-shuffle-service">Cosco: An Efficient Facebook-Scale Shuffle Service</a><a class="headerlink" href="#cosco-an-efficient-facebook-scale-shuffle-service" title="Permanent link">&para;</a></h3>
<p>Cosco is an efficient shuffle-as-a-service that powers Spark (and Hive) jobs at Facebook warehouse scale. It is implemented as a scalable, reliable and maintainable distributed system. Cosco is based on the idea of partial in-memory aggregation across a shared pool of distributed memory. This provides vastly improved efficiency in disk usage compared to Spark’s built-in shuffle. Long term, we believe the Cosco architecture will be key to efficiently supporting jobs at ever larger scale. In this talk we’ll take a deep dive into the Cosco architecture and describe how it’s deployed at Facebook. We will then describe how it’s integrated to run shuffle for Spark, and contrast it with Spark’s built-in sort-based shuffle mechanism and SOS (presented at Spark+AI Summit 2018).</p>
<p><strong><a href="../../../asset/pdf/cosco-an-efficient-facebookscale-shuffle-service.pdf">【PDF】Cosco: An Efficient Facebook-Scale Shuffle Service</a></strong></p>
<h3 id="review_1">Review<a class="headerlink" href="#review_1" title="Permanent link">&para;</a></h3>
<p><strong>背景</strong></p>
<p>存储计算分离，好处：硬件、优化、管理、配置</p>
<ul>
<li>计算：CPU、GPU、RAM</li>
<li>存储：Disk、持久存储、临时存储</li>
</ul>
<p>问题：磁盘服务时间、吞吐；写放大</p>
<p><strong>Cosco介绍</strong></p>
<ul>
<li>对于每个 Reducer 的分区，Mapper 共享一个预写缓冲区</li>
<li>Reducer 可以顺序读取写入的数据</li>
<li>IO吞吐：顺序读，增大IO大小</li>
<li>写放大：避免 Spill</li>
</ul>
<p><strong>问题</strong></p>
<ul>
<li>Shuffle Exchange 在磁盘上处理</li>
<li>单个 Shuffle Exchange 处理能力：PB级，10W Mapper，1W Reducer</li>
<li>写放大：3倍</li>
<li>IO吞吐：200k</li>
<li>IO并发：Reader 并发，M*R</li>
</ul>
<p><strong>方案</strong></p>
<ul>
<li>预写缓冲区（Write-ahead buffers）：对于每个 Reducer 的分区，Mapper 共享一个预写缓冲区，排序（可选）</li>
<li>传输（Delivery）：数据 Ack与Failover（Exactly once、At least once）</li>
<li>副本（Replication）：文件 Failover</li>
<li>元数据（Metadata）：Mapper 提交文件，Reducer 请求文件</li>
<li>调度器（Scheduler）：Shuffle 计算调度、容错</li>
</ul>
<p><strong>限制</strong></p>
<ul>
<li>数据容量</li>
<li>内存容量</li>
</ul>
<h2 id="tip">Tip<a class="headerlink" href="#tip" title="Permanent link">&para;</a></h2>
<h3 id="spark">Spark 常用参数<a class="headerlink" href="#spark" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>spark.executor.extraJavaOptions="-XX:+PrintGCDetails -XX:+PrintGCTimeStamps"</p>
<p>Executor JVM 参数</p>
</li>
<li>
<p>spark.executor.cores=2</p>
<p>Executor 核数</p>
</li>
<li>
<p>spark.executor.memory=4g</p>
<p>Executor 内存大小</p>
</li>
<li>
<p>spark.yarn.executor.memoryOverhead=1g</p>
<p>Executor 堆外内存大小</p>
</li>
<li>
<p>spark.driver.extraJavaOptions="-XX:+PrintGCDetails -XX:+PrintGCTimeStamps"</p>
<p>Driver JVM 参数</p>
</li>
<li>
<p>spark.driver.cores=2</p>
<p>Driver 核数</p>
</li>
<li>
<p>spark.driver.memory=4g</p>
<p>Driver 内存大小</p>
</li>
<li>
<p>spark.yarn.driver.memoryOverhead=1g</p>
<p>Driver 堆外内存大小</p>
</li>
<li>
<p>spark.speculation=true</p>
<p>开启推测执行</p>
</li>
<li>
<p>spark.speculation.quantile=0.75</p>
<p>进行推测执行的任务完成最小比例</p>
</li>
<li>
<p>spark.speculation.multiplier=1.5</p>
<p>满足最小完成比例条件下，进行推测执行的任务执行时间大于完成任务执行时间中位数的最小倍数</p>
</li>
<li>
<p>spark.memory.fraction=0.6</p>
<p>执行和存储内存占堆内存的比例，增加可能导致OOM；300MB保留内存，剩下为用户内存(1.0 - spark.memory.fraction) * (SYSTEM_MEMORY - RESERVED_MEMORY)</p>
</li>
<li>
<p>spark.memory.storageFraction=0.5</p>
<p>存储内存免于被计算驱逐的内存比例，驱逐通过LRU机制，计算内存不足可能导致spill到磁盘</p>
</li>
<li>
<p>spark.memory.offHeap.enabled=true</p>
<p>使用堆外内存，减少GC压力</p>
</li>
<li>
<p>spark.memory.offHeap.size=2147483648</p>
<p>设置堆外内存大小</p>
</li>
<li>
<p>spark.shuffle.file.buffer=32k</p>
<p>shuffle输出内存缓冲大小，减少磁盘IO压力</p>
</li>
<li>
<p>spark.unsafe.sorter.spill.reader.buffer.size=2097152</p>
<p>读取spill文件缓冲大小</p>
</li>
<li>
<p>spark.sql.autoBroadcastJoinThreshold=10m</p>
<p>表被广播的最大值</p>
</li>
<li>
<p>spark.sql.broadcastTimeout=300</p>
<p>表被广播的超时时间</p>
</li>
<li>
<p>spark.dynamicAllocation.enabled=true</p>
<p>开启动态资源分配</p>
</li>
<li>
<p>spark.dynamicAllocation.minExecutors=20</p>
<p>最少 Executor 数量</p>
</li>
<li>
<p>spark.dynamicAllocation.maxExecutors=200</p>
<p>最多 Executor 数量</p>
</li>
<li>
<p>spark.shuffle.service.enabled=true</p>
<p>开启外部 Shuffle Service</p>
</li>
<li>
<p>spark.shuffle.service.port=7337</p>
<p>Shuffle Service 端口</p>
</li>
<li>
<p>spark.hadoop.mapreduce.fileoutputcommitter.algorithm.version=2</p>
<p>FileOutputCommitter 使用 V2 算法，减少commitJob耗时，V1 增加了一致性保证</p>
</li>
</ul>
<h2 id="share">Share<a class="headerlink" href="#share" title="Permanent link">&para;</a></h2>
<h3 id="spark-shuffle-service"><a href="../../../share/2019/spark-shuffle-service/">Spark Shuffle Service</a><a class="headerlink" href="#spark-shuffle-service" title="Permanent link">&para;</a></h3>
<h2 id="reference">Reference<a class="headerlink" href="#reference" title="Permanent link">&para;</a></h2>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2013 - <span id="cyear">2013</span> HyperJ <script type="text/javascript">document.getElementById("cyear").innerText=new Date().getFullYear();document.write(unescape("%3Cdiv id='cnzz_stat_icon_1275779234'%3E%3C/div%3E%3Cscript src='https://s5.cnzz.com/z_stat.php%3Fid%3D1275779234%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script>
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
    
      <a href="https://hyperj.net" class="md-footer-social__link fa fa-h-square"></a>
    
      <a href="https://github.com/hyperj" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://www.linkedin.com/in/hyperj" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
    
  </body>
</html>